<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bocatto | Validando pago</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Tipografía -->
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500&display=swap" rel="stylesheet">

  <style>
    body { background:#111; color:#f7f7f7; }
    .navbar { font-family:'Oswald', sans-serif; }
    .card { background:#e6b800; border:1px solid #2a2a2a; }
    .muted { color:#bdbdbd; }
    .center-box {
      min-height: 70vh;
      display: flex; align-items: center; justify-content: center;
    }
  </style>
</head>
<body>

  
      <!--NAVBAR-->
<nav class="navbar navbar-expand-lg navbar-light bg-warning border-bottom border-secondary">
  <div class="container">
    <a class="navbar-brand" href="Web_principal.html">
      <i class="bi bi-bag"></i> Bocatto
    </a>
    <div class="ms-auto d-flex gap-2">
    <a href="Web_principal.html" class="btn btn-outline-light navbar-btn">
      <i class="bi bi-arrow-left"></i> Volver a la tienda
    </a>
    </div>
  </div>
</nav>
<!--
<nav class="navbar navbar-expand-lg navbar-light bg-warning border-bottom border-secondary">
  <div class="container">
    <a class="navbar-brand" href="Web_principal.html">
      <i class="bi bi-bag"></i> Bocatto
    </a>
    <div class="ms-auto">
      <a href="Web_principal.html" class="btn btn-outline-light">
        <i class="bi bi-arrow-left"></i> Volver a la tienda
      </a>
    </div>
  </div>
</nav>
-->
<main class="container center-box">
  <div class="text-center">
    <!-- Estado: validando -->
    <div id="box-loading">
      <div class="spinner-border" role="status" style="width:4rem;height:4rem;"></div>
      <div class="mt-3 fs-5">Validando pago… <span id="secs">15</span>s</div>
      <div class="muted small mt-2">No cierres esta ventana.</div>
    </div>

    <!-- Estado: aprobado -->
    <div id="box-ok" class="d-none">
      <i class="bi bi-check-circle-fill text-success" style="font-size:3rem;"></i>
      <div class="mt-2 fs-5 fw-semibold">Pago validado</div>
      <div class="muted small">Redirigiendo a “Tus pedidos”…</div>
    </div>

    <!-- Estado: rechazado (apagado por defecto) -->
    <div id="box-fail" class="d-none">
      <i class="bi bi-x-circle-fill text-danger" style="font-size:3rem;"></i>
      <div class="mt-2 fs-5 fw-semibold">Pago rechazado</div>
      <div class="muted small">Cambie de tarjeta o elija otro método de pago.</div>
      <div class="muted small">Redirigiendo a la forma de pago…</div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script src="js/app.js?v=4" defer></script>

<script>
(() => {
  // Configuración
  const API_URL = 'http://localhost:3000/graphql';
  const PEDIDO_KEY = 'pedido_actual_id';
  const USER_KEY = 'usuario_bocatto';

  // Referencias DOM
  const elSecs = document.getElementById('secs');
  const boxLoading = document.getElementById('box-loading');
  const boxOk = document.getElementById('box-ok');
  const boxFail = document.getElementById('box-fail');

  // Temporizador visual
  let secs = 3; 
  elSecs.textContent = secs;
  const timer = setInterval(() => {
    secs--;
    if(secs >= 0) elSecs.textContent = secs;
  }, 1000);

  // === LÓGICA DE PAGO REAL ===
  async function iniciarProcesoPago() {
    const pedidoId = sessionStorage.getItem(PEDIDO_KEY);
    const usuarioStorage = localStorage.getItem(USER_KEY);
    
    if (!pedidoId) {
      mostrarFallo('No se encontró el número de pedido.');
      return;
    }

    // Recuperamos token para autorizar la transacción
    let token = null;
    if (usuarioStorage) {
        const usuario = JSON.parse(usuarioStorage);
        token = usuario.token;
    }

    try {
      // 1. Construir la Mutation
      const query = `
        mutation ProcesarPago($pedidoId: ID!, $metodoPago: String!, $datosTarjeta: DatosTarjetaInput) {
          procesarPago(
            pedidoId: $pedidoId, 
            metodoPago: $metodoPago, 
            datosTarjeta: $datosTarjeta
          ) {
            transaccion { id estado codigoTransaccion }
            mensaje
          }
        }
      `;

// Recuperar el método de pago que guardamos en el checkout
      const metodoGuardado = sessionStorage.getItem('metodo_pago_actual') || 'tarjeta';

      const variables = {
        pedidoId: pedidoId,
        metodoPago: metodoGuardado, // Usamos el valor real (tarjeta o contraentrega)
        datosTarjeta: metodoGuardado === 'tarjeta' ? {
            numero: "4242424242424242", 
            mesVencimiento: "12",
            anioVencimiento: "30",
            cvv: "123",
            nombreTitular: "Cliente Bocatto"
        } : null // Si es contraentrega, no mandamos tarjeta
      };

      // 2. Hacer el Fetch directo al Backend
      // Usamos fetch directo aquí para no depender de si la clase GQL de app.js cargó o no
      const response = await fetch(API_URL, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': token || ''
        },
        body: JSON.stringify({ query, variables })
      });

      const json = await response.json();

      if (json.errors) {
        throw new Error(json.errors[0].message);
      }

      // 3. Éxito
      const transaccion = json.data.procesarPago.transaccion;
      console.log('✅ Transacción exitosa:', transaccion);
      
      mostrarExito();

    } catch (error) {
      console.error('❌ Error pago:', error);
      mostrarFallo(error.message);
    }
  }

  function mostrarExito() {
    clearInterval(timer);
    boxLoading.classList.add('d-none');
    boxOk.classList.remove('d-none');
    
    // Redirigir al tracking con el ID correcto
    const pedidoId = sessionStorage.getItem(PEDIDO_KEY);
    setTimeout(() => {
        window.location.href = `Est_pedido.html?id=${pedidoId}`;
    }, 2000);
  }

  function mostrarFallo(mensaje) {
    clearInterval(timer);
    boxLoading.classList.add('d-none');
    boxFail.classList.remove('d-none');
    
    const msgEl = document.createElement('div');
    msgEl.className = 'text-danger small mt-2';
    msgEl.textContent = mensaje;
    boxFail.appendChild(msgEl);

    setTimeout(() => {
        window.location.href = 'Ges_pagos.html';
    }, 3500);
  }

  // Arrancar
  iniciarProcesoPago();

})();
</script>
</body>
</html>
