<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bocatto | Mis direcciones</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{
      --bg:#111; --card:#1b1b1b; --muted:#bdbdbd; --line:#2a2a2a;
      --accent:#ffd54f; --accent-text:#111;
    }
    body{ background:var(--bg); color:#f7f7f7; }
    .navbar{ background:var(--accent)!important; }
    .navbar .navbar-brand, .navbar .nav-link, .navbar .btn{ color:var(--accent-text)!important; }
    .card{ background:var(--card); border:1px solid var(--line); }
    .muted{ color:var(--muted)!important; }
    .form-control, .form-select{ background:#141414; color:#eee; border-color:#333; }
    .addr-card{ transition:transform .08s ease; }
    .addr-card:hover{ transform: translateY(-1px); }
    .badge-dark{ background:#222; border:1px solid #333; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg border-bottom border-dark">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="Web_principal.html"><i class="bi bi-bag"></i> Bocatto</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navCli">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navCli">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="Web_principal.html">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="Menu.html">Menú</a></li>
        <li class="nav-item"><a class="nav-link" href="Ges_boletas.html">Tus pedidos</a></li>
        <li class="nav-item"><a class="nav-link active fw-semibold" href="Ges_direcciones.html">Direcciones</a></li>
      </ul>
      <div class="d-flex gap-2">
        <a href="Ges_pagos.html" class="btn btn-sm btn-outline-dark"><i class="bi bi-credit-card"></i> Ir a pago</a>
        <button id="btn-logout" class="btn btn-dark btn-sm"><i class="bi bi-box-arrow-right"></i> Salir</button>
      </div>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div class="row g-3">
    <div class="col-lg-7">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">Mis direcciones</h4>
        <span class="muted small">Selecciona, edita o elimina.</span>
      </div>
      <div id="lista" class="vstack gap-3"></div>
      <div id="sin" class="text-center muted mt-3" style="display:none;">No tienes direcciones guardadas.</div>
    </div>

    <div class="col-lg-5">
      <div class="card rounded-4">
        <div class="card-body">
          <h5 class="mb-3">Agregar / Editar dirección</h5>
          <div class="row g-2">
            <div class="col-12">
              <label class="form-label muted">Alias (Casa, Trabajo, etc.)</label>
              <input id="f-alias" type="text" class="form-control" placeholder="Casa">
            </div>
            <div class="col-8">
              <label class="form-label muted">Calle y número</label>
              <input id="f-calle" type="text" class="form-control" placeholder="Av. Pajaritos 1234">
            </div>
            <div class="col-4">
              <label class="form-label muted">Depto / Casa</label>
              <input id="f-depto" type="text" class="form-control" placeholder="Dpto 44">
            </div>
            <div class="col-6">
              <label class="form-label muted">Comuna</label>
              <input id="f-comuna" type="text" class="form-control" placeholder="Maipú">
            </div>
            <div class="col-6">
              <label class="form-label muted">Ciudad</label>
              <input id="f-ciudad" type="text" class="form-control" placeholder="Santiago">
            </div>
            <div class="col-12">
              <label class="form-label muted">Indicaciones (opcional)</label>
              <input id="f-notas" type="text" class="form-control" placeholder="Portón negro, timbre 2">
            </div>
            <div class="col-12">
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="f-default">
                <label class="form-check-label" for="f-default">Marcar como predeterminada</label>
              </div>
            </div>
            <div class="col-12 d-grid mt-2">
              <button id="btn-guardar" class="btn btn-danger">Guardar dirección</button>
            </div>
            <div class="col-12 d-grid">
              <button id="btn-limpiar" class="btn btn-outline-light">Limpiar formulario</button>
            </div>
          </div>
          <input type="hidden" id="f-id">
        </div>
      </div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
(() => {
  // Solo cliente (suave)
  try {
    const role = localStorage.getItem('userRole') || 'visitante';
    if (role !== 'cliente') {
      // window.location.href = 'Web_principal.html';
    }
  } catch (_){}

  const KEY = 'direcciones_bocatto';
  let direcciones = [];
  try { direcciones = JSON.parse(localStorage.getItem(KEY)) || []; } catch(_){ direcciones = []; }

  if (!direcciones.length) {
    direcciones = [
      { id: genId(), alias:'Casa', calle:'Av. Pajaritos 1234', depto:'', comuna:'Maipú', ciudad:'Santiago', notas:'Portón negro', predet:true },
      { id: genId(), alias:'Trabajo', calle:'Calle Vecinal 456', depto:'Of 12', comuna:'Maipú', ciudad:'Santiago', notas:'Recepción 2° piso', predet:false },
    ];
    save();
  }

  // UI refs
  const lista = document.getElementById('lista');
  const sin = document.getElementById('sin');

  // Form refs
  const fid = $('#f-id'), falias = $('#f-alias'), fcalle = $('#f-calle'), fdepto = $('#f-depto'),
        fcomuna = $('#f-comuna'), fciudad = $('#f-ciudad'), fnotas = $('#f-notas'), fdefault = $('#f-default');

  function $(s){ return document.querySelector(s); }
  const CLP = n => '$' + Number(n||0).toLocaleString('es-CL');
  function genId(){ return Math.floor(100000 + Math.random()*900000); }
  function save(){ try { localStorage.setItem(KEY, JSON.stringify(direcciones)); } catch(_){} }

  function render(){
    lista.innerHTML = '';
    sin.style.display = direcciones.length ? 'none' : 'block';

    direcciones.forEach(d => {
      const card = document.createElement('div');
      card.className = 'card addr-card rounded-4';
      card.innerHTML = `
        <div class="card-body">
          <div class="row g-2 align-items-center">
            <div class="col-12 col-lg-8">
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="fw-semibold">${d.alias}</span>
                ${d.predet ? '<span class="badge badge-dark">Predeterminada</span>' : ''}
              </div>
              <div class="muted small">${d.calle}${d.depto ? ', '+d.depto:''}</div>
              <div class="muted small">${d.comuna}, ${d.ciudad}</div>
              ${d.notas ? `<div class="muted small">Notas: ${d.notas}</div>`:''}
            </div>
            <div class="col-12 col-lg-4 d-flex justify-content-end gap-2">
              <button class="btn btn-outline-light btn-sm" data-act="usar" data-id="${d.id}">
                <i class="bi bi-check2-circle"></i> Usar esta
              </button>
              <button class="btn btn-outline-light btn-sm" data-act="pred" data-id="${d.id}">
                <i class="bi bi-star"></i> Predeterminada
              </button>
              <button class="btn btn-danger btn-sm" data-act="edit" data-id="${d.id}">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-outline-light btn-sm" data-act="del" data-id="${d.id}">
                <i class="bi bi-trash3"></i>
              </button>
            </div>
          </div>
        </div>
      `;
      lista.appendChild(card);
    });
  }

  // Acciones de lista
  document.addEventListener('click', e => {
    const btn = e.target.closest('button[data-act]');
    if (!btn) return;
    const id = Number(btn.dataset.id);
    const act = btn.dataset.act;
    const idx = direcciones.findIndex(x=>x.id===id);
    if (idx<0) return;

    if (act==='del') {
      if (confirm('¿Eliminar esta dirección?')) {
        direcciones.splice(idx,1); save(); render();
      }
    }
    if (act==='edit') {
      const d = direcciones[idx];
      fid.value = d.id;
      falias.value = d.alias || '';
      fcalle.value = d.calle || '';
      fdepto.value = d.depto || '';
      fcomuna.value = d.comuna || '';
      fciudad.value = d.ciudad || '';
      fnotas.value = d.notas || '';
      fdefault.checked = !!d.predet;
      window.scrollTo({ top: document.body.scrollHeight, behavior:'smooth' });
    }
    if (act==='pred') {
      direcciones = direcciones.map(x => ({...x, predet: x.id===id}));
      save(); render();
      alert('Dirección marcada como predeterminada.');
    }
    if (act==='usar') {
      const d = direcciones[idx];
      // Guardar para el pedido actual (no conecta “lógico”, solo deja listo)
      localStorage.setItem('entrega_tipo','despacho');
      localStorage.setItem('delivery_address', `${d.calle}${d.depto? ', '+d.depto:''}, ${d.comuna}, ${d.ciudad}`);
      alert('Dirección aplicada al pedido actual.');
      // Si quieres, vuelve a la página de pago:
      window.location.href = 'Ges_pagos.html';
    }
  });

  // Guardar / limpiar
  document.getElementById('btn-guardar').addEventListener('click', () => {
    const id = Number(fid.value);
    const obj = {
      id: id || genId(),
      alias: falias.value.trim() || 'Sin alias',
      calle: fcalle.value.trim(),
      depto: fdepto.value.trim(),
      comuna: fcomuna.value.trim(),
      ciudad: fciudad.value.trim(),
      notas: fnotas.value.trim(),
      predet: fdefault.checked
    };
    if (!obj.calle || !obj.comuna || !obj.ciudad) {
      alert('Completa calle, comuna y ciudad.');
      return;
    }
    if (obj.predet) {
      direcciones = direcciones.map(x => ({...x, predet:false}));
    }
    if (id) {
      const i = direcciones.findIndex(x=>x.id===id);
      if (i>=0) direcciones[i] = obj;
    } else {
      direcciones.push(obj);
    }
    save(); limpiar(); render();
  });

  document.getElementById('btn-limpiar').addEventListener('click', limpiar);
  function limpiar(){
    fid.value = '';
    falias.value = ''; fcalle.value=''; fdepto.value='';
    fcomuna.value=''; fciudad.value=''; fnotas.value='';
    fdefault.checked = false;
  }

  // Logout
  document.getElementById('btn-logout')?.addEventListener('click', ()=>{
    try { localStorage.setItem('userRole','visitante'); } catch(_){}
    window.location.href = 'Web_principal.html';
  });

  render();
})();
</script>

</body>
</html>
