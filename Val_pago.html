<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bocatto | Validando pago</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500&display=swap" rel="stylesheet">
  <style>
    body { background:#111; color:#f7f7f7; }
    .navbar { font-family:'Oswald', sans-serif; }
    .center-box { min-height: 70vh; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>
  
<nav class="navbar navbar-expand-lg navbar-light bg-warning border-bottom border-secondary">
  <div class="container">
    <a class="navbar-brand" href="Web_principal.html"><i class="bi bi-bag"></i> Bocatto</a>
  </div>
</nav>

<main class="container center-box">
  <div class="text-center">
    <!-- Estado: Validando -->
    <div id="box-loading">
      <div class="spinner-border text-warning" role="status" style="width:4rem;height:4rem;"></div>
      <div class="mt-3 fs-5">Procesando pago seguroâ€¦ <span id="secs"></span></div>
      <div class="text-muted small mt-2" id="msg-status">Conectando con el banco...</div>
    </div>

    <!-- Estado: Aprobado -->
    <div id="box-ok" class="d-none">
      <i class="bi bi-check-circle-fill text-success" style="font-size:3rem;"></i>
      <div class="mt-2 fs-5 fw-semibold">Â¡Pago Exitoso!</div>
      <div class="text-muted small">Tu pedido ha sido confirmado.</div>
    </div>

    <!-- Estado: Rechazado -->
    <div id="box-fail" class="d-none">
      <i class="bi bi-x-circle-fill text-danger" style="font-size:3rem;"></i>
      <div class="mt-2 fs-5 fw-semibold">No se pudo procesar</div>
      <div id="error-detail" class="text-danger small"></div>
      <button class="btn btn-outline-light mt-3" onclick="window.location.href='Menu.html'">Volver al MenÃº</button>
    </div>
  </div>
</main>

<script>
/* ================= LOGICA DE PASARELA (Val_pago.html) ================= */
(() => {
  const CONFIG = {
      API_URL: 'http://localhost:3000/graphql',
      KEYS: { PEDIDO: 'pedido_actual_id', METODO: 'metodo_pago_actual', TARJETA: 'datos_tarjeta_temp', USER: 'usuario_bocatto' }
  };

  const UI = {
      boxLoading: document.getElementById('box-loading'),
      boxOk: document.getElementById('box-ok'),
      boxFail: document.getElementById('box-fail'),
      msgStatus: document.getElementById('msg-status'),
      errorDetail: document.getElementById('error-detail'),
      timerSecs: document.getElementById('secs')
  };

  // Cliente GraphQL Local (Lee Token Real)
  async function gqlRequest(query, variables = {}) {
    const usuarioStorage = localStorage.getItem(CONFIG.KEYS.USER);
    let token = usuarioStorage ? JSON.parse(usuarioStorage).token : '';

    const response = await fetch(CONFIG.API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': token },
      body: JSON.stringify({ query, variables })
    });
    const json = await response.json();
    if (json.errors) throw new Error(json.errors[0].message);
    return json.data;
  }

  async function iniciarProcesoPago() {
    try {
        const pedidoId = sessionStorage.getItem(CONFIG.KEYS.PEDIDO);
        const metodoPago = sessionStorage.getItem(CONFIG.KEYS.METODO);
        
        if (!pedidoId) throw new Error('No se encontrÃ³ orden activa.');

        let datosTarjeta = null;
        let guardarTarjeta = false;

        // 1. Recuperar datos de tarjeta (si aplica)
        if (metodoPago === 'tarjeta') {
            const datosRaw = sessionStorage.getItem(CONFIG.KEYS.TARJETA);
            if (datosRaw) {
                const datosObj = JSON.parse(datosRaw);
                guardarTarjeta = datosObj.guardarTarjeta;
                // Limpiamos el objeto para la API
                datosTarjeta = {
                    numero: datosObj.numero, mesVencimiento: datosObj.mesVencimiento,
                    anioVencimiento: datosObj.anioVencimiento, cvv: datosObj.cvv,
                    nombreTitular: datosObj.nombreTitular
                };
            }
        }

        // 2. Procesar Pago (Cobro)
        UI.msgStatus.textContent = "Autorizando transacciÃ³n...";
        const mutationPago = `mutation ProcesarPago($pedidoId: ID!, $metodoPago: String!, $datosTarjeta: DatosTarjetaInput) {
            procesarPago(pedidoId: $pedidoId, metodoPago: $metodoPago, datosTarjeta: $datosTarjeta) {
                transaccion { id estado }
            }
        }`;
        await gqlRequest(mutationPago, { pedidoId, metodoPago, datosTarjeta });

        // 3. Guardar Tarjeta (Si usuario quiso)
        if (metodoPago === 'tarjeta' && guardarTarjeta && datosTarjeta) {
            UI.msgStatus.textContent = "Guardando tarjeta en tu perfil...";
            console.log('ðŸ’¾ Intentando guardar tarjeta...');
            
            const mutationGuardar = `mutation GuardarMetodoPago($datosTarjeta: DatosTarjetaInput!, $alias: String) {
                guardarMetodoPago(datosTarjeta: $datosTarjeta, alias: $alias) { metodoPago { id } }
            }`;
            
            try {
                await gqlRequest(mutationGuardar, { 
                    datosTarjeta, 
                    alias: `Tarjeta terminada en ${datosTarjeta.numero.slice(-4)}`
                });
                console.log('âœ… Tarjeta guardada con Ã©xito');
            } catch (e) {
                console.warn('âš ï¸ Error al guardar tarjeta (pero pago exitoso):', e.message);
            }
        }

        // 4. Ã‰xito
        sessionStorage.removeItem(CONFIG.KEYS.TARJETA);
        UI.boxLoading.classList.add('d-none');
        UI.boxOk.classList.remove('d-none');
        setTimeout(() => window.location.href = `Est_pedido.html?id=${pedidoId}`, 2500);

    } catch (error) {
        console.error(error);
        UI.boxLoading.classList.add('d-none');
        UI.boxFail.classList.remove('d-none');
        UI.errorDetail.textContent = error.message;
    }
  }

  // Timer visual
  let s = 3; UI.timerSecs.textContent = s;
  setInterval(() => { if(s>0) UI.timerSecs.textContent = --s; }, 1000);

  iniciarProcesoPago();
})();
</script>
</body>
</html>