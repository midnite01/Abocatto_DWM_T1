<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bocatto | Panel de Reportes</title>

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#000000; --card:#e6b800; --lawawa:#e6b800; --muted:#000000; --line:#2a2a2a;
      --accent:#e6b800; --accent-text:#000000; /* navbar admin */
      --ok:#2ecc71; --warn:#f39c12; --info:#000000;
    }
    body{ background:var(--bg); color:#ffffff; }
    .navbar{ background:var(--accent)!important; }
    .navbar .navbar-brand, .navbar .nav-link, .navbar .btn{ color:var(--accent-text)!important; }
    .card{ background:var(--card); border:1px solid var(--line); }
    .muted{ color:var(--muted)!important; }
    .kpi{
      background:#e6b800; border:1px solid #2a2a2a; border-radius:16px; padding:16px;
    }
    .kpi .ttl{ font-size:.85rem; color:var(--muted); }
    .kpi .val{ font-size:1.25rem; font-weight:700; }
    .chip{ background:#e6b800; border:1px solid #e6b800; border-radius:999px; padding:.35rem .8rem; cursor:pointer; }
    .chip.active{ background:#ffd54f; border-color:#ffd54f; }
    .input-dark, .form-select{ background:#121212; color:#eee; border-color:#444; }
    .btn-outline-light{ border-color:#aaa; color:#eee; }
    .btn-outline-light:hover{ background:#eee; color:#111; }
    .divider{ height:1px; background:var(--line); margin:8px 0; }
  </style>
</head>
<body>

<!-- NAVBAR ADMIN -->
<nav class="navbar navbar-expand-lg navbar-light bg-warning border-bottom border-dark">
  <div class="container">
    <a class="navbar-brand fw-semibold" href="Web_principal.html"><i class="bi bi-speedometer2"></i> Bocatto Admin</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navAdmin">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navAdmin">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link active fw-semibold" href="Ges_reportes.html">Reportes</a></li>
      </ul>
      <div class="d-flex gap-2">
        <a href="Menu.html" class="btn btn-sm btn-outline-dark"><i class="bi bi-shop"></i> Ver menú</a>
        <button id="btn-logout" class="btn btn-dark btn-sm"><i class="bi bi-box-arrow-right"></i> Salir</button>
      </div>
    </div>
  </div>
</nav>

<main class="container my-4">

  <!-- Filtros -->
  <div class="card rounded-4 mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label muted">Período</label>
          <div class="d-flex gap-2 flex-wrap">
            <span class="chip active" data-mode="dia">Día</span>
            <span class="chip" data-mode="mes">Mes</span>
            <span class="chip" data-mode="anio">Año</span>
          </div>
        </div>
        <div class="col-md-4" id="box-dia">
          <label class="form-label muted">Selecciona día</label>
          <input type="date" id="inp-dia" class="form-control input-dark">
        </div>
        <div class="col-md-4 d-none" id="box-mes">
          <label class="form-label muted">Selecciona mes</label>
          <input type="month" id="inp-mes" class="form-control input-dark">
        </div>
        <div class="col-md-4 d-none" id="box-anio">
          <label class="form-label muted">Selecciona año</label>
          <select id="inp-anio" class="form-select input-dark"></select>
        </div>
        <div class="col-md-4 ms-auto text-end">
          <button id="btn-export" class="btn btn-danger"><i class="bi bi-filetype-csv"></i> Generar reporte</button>
        </div>
      </div>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-6 col-lg-3">
      <div class="kpi h-100">
        <div class="ttl">Producto más vendido</div>
        <div class="val" id="kpi-prod">—</div>
        <div class="muted small" id="kpi-prod-sub">—</div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="kpi h-100">
        <div class="ttl">Método de pago más utilizado</div>
        <div class="val" id="kpi-pay">—</div>
        <div class="muted small" id="kpi-pay-sub">—</div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="kpi h-100">
        <div class="ttl">Tipo de despacho predominante</div>
        <div class="val" id="kpi-type">—</div>
        <div class="muted small" id="kpi-type-sub">—</div>
      </div>
    </div>
    <div class="col-md-6 col-lg-3">
      <div class="kpi h-100">
        <div class="ttl">Ventas totales del período</div>
        <div class="val" id="kpi-sales">$0</div>
        <div class="muted small" id="kpi-sales-sub">—</div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="row g-3">
    <div class="col-lg-7">
      <div class="card rounded-4">
        <div class="card-body">
          <h6 class="mb-3">Top productos por ventas</h6>
          <canvas id="chartTop"></canvas>
          <div class="muted small mt-2" id="noteTop">Porcentaje según ventas del período.</div>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card rounded-4 mb-3">
        <div class="card-body">
          <h6 class="mb-3">Métodos de pago</h6>
          <canvas id="chartPay"></canvas>
        </div>
      </div>
      <div class="card rounded-4">
        <div class="card-body">
          <h6 class="mb-3">Tipo de entrega</h6>
          <canvas id="chartType"></canvas>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
(() => {
  // ====== Datos ======
  const KEY = 'pedidos_bocatto';
  let pedidos = [];
  try { pedidos = JSON.parse(localStorage.getItem(KEY)) || []; } catch(_) { pedidos = []; }

  if (!pedidos.length) {
    // Semilla de datos inventados (últimos 6 meses, distintos productos/medios de pago/entrega)
    const nombres = ['Pesto Margarita','Chicken Honey Mustard','Full Veggie','Bocatto Clásico','BBQ Chicken','4 Quesos','Hawaiana','Napolitana'];
    const metodos = ['tarjeta','contraentrega'];
    const entregas = ['despacho','retiro'];

    function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function dateBack(days){ return new Date(Date.now() - days*86400000).toISOString(); }
    function item(){ 
      const nombre = nombres[rand(0,nombres.length-1)];
      const precio = [4990,6990,8990,11990,12990,14990,16990][rand(0,6)];
      const cantidad = rand(1,3);
      return { nombre, precio, cantidad };
    }
    pedidos = Array.from({length: 120}).map((_,i)=>({
      id: 100000 + i,
      boleta: 2000000 + i,
      fecha: dateBack(rand(0, 180)),
      estado: ['en_preparacion','en_camino','entregado'][rand(0,2)],
      entrega: { tipo: entregas[rand(0,1)], direccion: 'Maipú' },
      pago: { metodo: metodos[rand(0,1)] },
      items: Array.from({length: rand(1,4)}, item)
    }));
    try { localStorage.setItem(KEY, JSON.stringify(pedidos)); } catch(_){}
  }

  // ====== Utilidades ======
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const CLP = n => '$' + Number(n||0).toLocaleString('es-CL');

  function ymd(d){ return [d.getFullYear(), d.getMonth()+1, d.getDate()]; }

  function filterByPeriod(mode, valueISO){
    const dsel = valueISO ? new Date(valueISO) : new Date();
    const [Y,M,D] = ymd(dsel);
    return pedidos.filter(p => {
      const d = new Date(p.fecha);
      const [y,m,dn] = ymd(d);
      if (mode==='dia')  return y===Y && m===M && dn===D;
      if (mode==='mes')  return y===Y && m===M;
      if (mode==='anio') return y===Y;
      return false;
    });
  }

  function sum(items, f){ return items.reduce((a,x)=>a+f(x),0); }

  function buildStats(list){
    const totalVentas = sum(list, p => sum(p.items||[], i => (i.precio||0)*(i.cantidad||0)));
    // productos (por ventas $)
    const prodMap = {};
    list.forEach(p => (p.items||[]).forEach(i => {
      prodMap[i.nombre] = (prodMap[i.nombre]||0) + (i.precio||0)*(i.cantidad||0);
    }));
    const prods = Object.entries(prodMap).map(([nombre,ventas]) => ({nombre, ventas}));
    prods.sort((a,b)=>b.ventas-a.ventas);
    // métodos de pago (por cantidad de pedidos)
    const payMap = {};
    list.forEach(p => payMap[p.pago?.metodo||'desconocido'] = (payMap[p.pago?.metodo||'desconocido']||0)+1);
    const pays = Object.entries(payMap).map(([metodo,count])=>({metodo, count}));
    pays.sort((a,b)=>b.count-a.count);
    // tipo de entrega (por cantidad de pedidos)
    const typeMap = {};
    list.forEach(p => typeMap[p.entrega?.tipo||'desconocido'] = (typeMap[p.entrega?.tipo||'desconocido']||0)+1);
    const types = Object.entries(typeMap).map(([tipo,count])=>({tipo, count}));
    types.sort((a,b)=>b.count-a.count);

    return { totalVentas, prods, pays, types };
  }

  // ====== UI Filtros ======
  // Modo por defecto: día de hoy
  let mode = 'dia';
  $('#inp-dia').value = new Date().toISOString().slice(0,10);
  $('#inp-mes').value = new Date().toISOString().slice(0,7);
  // años disponibles (según datos)
  const ys = Array.from(new Set(pedidos.map(p=>new Date(p.fecha).getFullYear()))).sort((a,b)=>b-a);
  $('#inp-anio').innerHTML = ys.map(y=>`<option value="${y}">${y}</option>`).join('');
  $('#inp-anio').value = String(ys[0] || new Date().getFullYear());

  $$('.chip').forEach(c => c.addEventListener('click', () => {
    $$('.chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');
    mode = c.dataset.mode;
    $('#box-dia').classList.toggle('d-none', mode!=='dia');
    $('#box-mes').classList.toggle('d-none', mode!=='mes');
    $('#box-anio').classList.toggle('d-none', mode!=='anio');
    refresh();
  }));
  ['inp-dia','inp-mes','inp-anio'].forEach(id => {
    document.getElementById(id).addEventListener('change', refresh);
  });

  // ====== Charts ======
  let chartTop, chartPay, chartType;

  function destroy(c){ if (c) { c.destroy(); } }

  function refresh(){
    const valueISO = mode==='dia' ? $('#inp-dia').value
                     : mode==='mes' ? ($('#inp-mes').value+'-01')
                     : ($('#inp-anio').value+'-01-01');
    const data = filterByPeriod(mode, valueISO);
    const { totalVentas, prods, pays, types } = buildStats(data);

    // KPIs
    const topProd = prods[0];
    const prodPct = totalVentas > 0 ? Math.round((topProd?.ventas||0)*100/totalVentas) : 0;
    $('#kpi-prod').textContent = topProd ? topProd.nombre : '—';
    $('#kpi-prod-sub').textContent = topProd ? `${CLP(topProd.ventas)} • ${prodPct}% del período` : 'Sin ventas';

    const topPay = pays[0];
    const payTotal = sum(pays, p=>p.count) || 0;
    const payPct = payTotal>0 ? Math.round((topPay?.count||0)*100/payTotal) : 0;
    $('#kpi-pay').textContent = topPay ? aliasPay(topPay.metodo) : '—';
    $('#kpi-pay-sub').textContent = topPay ? `${topPay.count} pedidos • ${payPct}%` : '—';

    const topType = types[0];
    const typeTotal = sum(types, t=>t.count) || 0;
    const typePct = typeTotal>0 ? Math.round((topType?.count||0)*100/typeTotal) : 0;
    $('#kpi-type').textContent = topType ? aliasType(topType.tipo) : '—';
    $('#kpi-type-sub').textContent = topType ? `${topType.count} pedidos • ${typePct}%` : '—';

    $('#kpi-sales').textContent = CLP(totalVentas);
    $('#kpi-sales-sub').textContent = data.length ? `${data.length} pedidos` : '—';

    // Charts
    const topN = prods.slice(0,5);
    const labelsTop = topN.map(x=>x.nombre);
    const valsTop = topN.map(x=>x.ventas);
    destroy(chartTop);
    chartTop = new Chart(document.getElementById('chartTop'), {
      type: 'bar',
      data: { labels: labelsTop, datasets: [{ label: 'Ventas ($)', data: valsTop }]},
      options: {
        scales: { x: { ticks: { color:'#ddd' } }, y: { ticks: { color:'#ddd' } } },
        plugins: {
          legend: { labels:{ color:'#ddd' } },
          tooltip: {
            callbacks: {
              label: ctx => {
                const v = ctx.parsed.y || 0;
                const pct = totalVentas>0 ? (v*100/totalVentas) : 0;
                return ` ${CLP(v)}  (${pct.toFixed(1)}%)`;
              }
            }
          }
        }
      }
    });

    const payLabels = pays.map(p=>aliasPay(p.metodo));
    const payVals   = pays.map(p=>p.count);
    destroy(chartPay);
    chartPay = new Chart(document.getElementById('chartPay'), {
      type:'doughnut',
      data:{ labels: payLabels, datasets:[{ data: payVals }] },
      options:{ plugins:{ legend:{ labels:{ color:'#ddd' } } } }
    });

    const typeLabels = types.map(t=>aliasType(t.tipo));
    const typeVals   = types.map(t=>t.count);
    destroy(chartType);
    chartType = new Chart(document.getElementById('chartType'), {
      type:'doughnut',
      data:{ labels: typeLabels, datasets:[{ data: typeVals }] },
      options:{ plugins:{ legend:{ labels:{ color:'#ddd' } } } }
    });

    // Export CSV
    document.getElementById('btn-export').onclick = () => exportCSV({
      mode, valueISO, totalVentas, topProd, prodPct, topPay, payPct, topType, typePct,
      pays, types, prods
    });
  }

  function aliasPay(m){
    return m==='tarjeta' ? 'Tarjeta' : (m==='contraentrega' ? 'Contra entrega' : 'Otro');
  }
  function aliasType(t){
    return t==='retiro' ? 'Retiro en local' : (t==='despacho' ? 'Despacho' : 'Otro');
  }

  function exportCSV(ctx){
    const lines = [];
    lines.push('Reporte Bocatto');
    lines.push(`Periodo,${ctx.mode},${ctx.valueISO}`);
    lines.push(`Ventas totales,${ctx.totalVentas}`);
    lines.push(`Producto más vendido,${ctx.topProd?ctx.topProd.nombre:'—'},${ctx.topProd?ctx.topProd.ventas:0},${ctx.prodPct}%`);
    lines.push(`Método de pago más usado,${ctx.topPay?aliasPay(ctx.topPay.metodo):'—'},${ctx.topPay?ctx.topPay.count:0},${ctx.payPct}%`);
    lines.push(`Tipo de entrega predominante,${ctx.topType?aliasType(ctx.topType.tipo):'—'},${ctx.topType?ctx.topType.count:0},${ctx.typePct}%`);
    lines.push('');
    lines.push('Top productos (ventas $)');
    lines.push('Producto,Ventas');
    ctx.prods.slice(0,10).forEach(p=>lines.push(`${p.nombre},${p.ventas}`));
    lines.push('');
    lines.push('Métodos de pago,cantidad');
    ctx.pays.forEach(p=>lines.push(`${aliasPay(p.metodo)},${p.count}`));
    lines.push('');
    lines.push('Tipos de entrega,cantidad');
    ctx.types.forEach(t=>lines.push(`${aliasType(t.tipo)},${t.count}`));

    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `reporte_bocatto_${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Logout simple
  document.getElementById('btn-logout')?.addEventListener('click', ()=>{
    try { localStorage.setItem('userRole','visitante'); } catch(_){}
    window.location.href = 'Web_principal.html';
  });

  // Primer render
  refresh();
})();
</script>

</body>
</html>
